name: Torqued Enterprise CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: 18
  CACHE_KEY: node-modules-${{ hashFiles('**/package-lock.json') }}

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Security Audit
        run: |
          npm audit --audit-level high
          npx snyk test --severity-threshold=high
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  quality-gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Lint check
        run: npm run lint
      
      - name: Type check
        run: npx tsc --noEmit
      
      - name: Bundle analysis
        run: npm run analyze:bundle

  test-suite:
    runs-on: ubuntu-latest
    needs: [security-scan, quality-gates]
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    strategy:
      matrix:
        test-type: [unit, integration, e2e]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Unit Tests
        if: matrix.test-type == 'unit'
        run: |
          npm test -- --coverage --reporter=json --outputFile=coverage.json
          
      - name: Run Integration Tests
        if: matrix.test-type == 'integration'
        env:
          REDIS_URL: redis://localhost:6379
        run: npm run test:integration
      
      - name: Run E2E Tests
        if: matrix.test-type == 'e2e'
        run: |
          npx playwright install --with-deps
          npm run test:playwright
          
      - name: Upload Coverage
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.json

  performance-audit:
    runs-on: ubuntu-latest
    needs: [test-suite]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install and Build
        run: |
          npm ci
          npm run build
          
      - name: Performance Audit
        run: |
          npm run preview &
          sleep 5
          npm run performance:audit
          
      - name: Upload Performance Report
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-report
          path: ./reports/lighthouse.json

  canary-deployment:
    runs-on: ubuntu-latest
    needs: [performance-audit]
    if: github.ref == 'refs/heads/develop'
    environment: canary
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to Canary
        env:
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE_CANARY }}
          SHOPIFY_TOKEN: ${{ secrets.SHOPIFY_TOKEN_CANARY }}
          SHOPIFY_THEME_ID: ${{ secrets.SHOPIFY_THEME_ID_CANARY }}
        run: |
          npm ci
          npm run build
          npm run shopify:deploy

  production-deployment:
    runs-on: ubuntu-latest
    needs: [performance-audit]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install and Build
        run: |
          npm ci
          npm run ai:optimize
          
      - name: Blue-Green Deployment
        env:
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_TOKEN: ${{ secrets.SHOPIFY_TOKEN }}
          SHOPIFY_THEME_ID: ${{ secrets.SHOPIFY_THEME_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          # Deploy to staging theme first
          STAGING_THEME_ID=$(curl -H "X-Shopify-Access-Token: $SHOPIFY_TOKEN" \
            "https://$SHOPIFY_STORE/admin/api/2024-01/themes.json" | \
            jq -r '.themes[] | select(.name=="staging") | .id')
          
          SHOPIFY_THEME_ID=$STAGING_THEME_ID npm run shopify:deploy
          
          # Health check on staging
          sleep 10
          curl -f "https://$SHOPIFY_STORE/?preview_theme_id=$STAGING_THEME_ID" || exit 1
          
          # Deploy to production
          npm run shopify:deploy
          
          # Deploy edge workers
          npm run deploy:edge
          
      - name: Post-Deploy Verification
        run: |
          # Smoke tests on production
          curl -f "https://${{ secrets.SHOPIFY_STORE }}" || exit 1
          
      - name: Rollback on Failure
        if: failure()
        env:
          SHOPIFY_STORE: ${{ secrets.SHOPIFY_STORE }}
          SHOPIFY_TOKEN: ${{ secrets.SHOPIFY_TOKEN }}
        run: |
          # Rollback to previous theme
          PREV_THEME_ID=$(curl -H "X-Shopify-Access-Token: $SHOPIFY_TOKEN" \
            "https://$SHOPIFY_STORE/admin/api/2024-01/themes.json" | \
            jq -r '.themes[] | select(.name=="backup") | .id')
          
          curl -X PUT -H "X-Shopify-Access-Token: $SHOPIFY_TOKEN" \
            -H "Content-Type: application/json" \
            "https://$SHOPIFY_STORE/admin/api/2024-01/themes/$PREV_THEME_ID.json" \
            -d '{"theme":{"role":"main"}}'

  notify-success:
    runs-on: ubuntu-latest
    needs: [production-deployment]
    if: success()
    steps:
      - name: Notify Slack Success
        uses: slackapi/slack-github-action@v2
        with:
          payload: |
            {
              "text": "?? Production deployment successful!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "? *Torqued v${{ github.sha }}* deployed successfully to production"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify-failure:
    runs-on: ubuntu-latest
    needs: [production-deployment]
    if: failure()
    steps:
      - name: Notify Slack Failure
        uses: slackapi/slack-github-action@v2
        with:
          payload: |
            {
              "text": "?? Production deployment failed!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn", 
                    "text": "? *Torqued v${{ github.sha }}* deployment failed. Rollback initiated."
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
